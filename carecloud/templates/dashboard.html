{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="agent-container">
    <!-- Agent Status Header -->
    <div class="agent-status-header">
        <div class="status-left">
            <div class="agent-indicator active"></div>
            <div class="status-text">
                <h1>CareCloud Agent</h1>
                <p class="status-label">Agent Active</p>
            </div>
        </div>
        <div class="user-info">
            <span class="user-name">{{ user.name }}</span>
        </div>
    </div>

    <div class="dashboard-layout">
        <!-- Main Action Card -->
        <div class="action-card">
            <!-- Toxicity Meter Gauge -->
            <div class="meter-container">
                <div class="gauge-wrapper">
                    <div class="gauge-background"></div>
                    <div class="gauge-needle" id="gaugeNeedle"></div>
                    <div class="gauge-center"></div>
                </div>
                <div class="gauge-labels">
                    <span>Safe</span>
                    <span>Moderate</span>
                    <span>High</span>
                </div>
            </div>

            <div class="card-header">
                <h2>Analyze Content</h2>
                <p class="card-subtitle">Submit text or image for safety analysis</p>
            </div>

            <form id="analyzeForm" class="analyze-form">
                <div class="form-field">
                    <label for="text_content">Text or Message</label>
                    <textarea 
                        id="text_content" 
                        name="text" 
                        rows="6" 
                        placeholder="Paste text, comment, or message to analyze..."
                        class="input-textarea"
                    ></textarea>
                </div>

                <div class="form-field">
                    <label for="image_file">Screenshot (Optional)</label>
                    <input 
                        type="file" 
                        id="image_file" 
                        name="image" 
                        accept="image/*"
                        class="input-file"
                    >
                </div>

                <button type="submit" class="btn-analyze" id="analyzeBtn">Analyze Now</button>
            </form>

            <!-- Analysis State Display -->
            <div id="stateContainer" class="state-display">
                <div id="idleState" class="state idle-state">
                    <p>Ready to analyze. Submit content above.</p>
                </div>

                <div id="analyzingState" class="state analyzing-state" style="display: none;">
                    <div class="agent-spinner"></div>
                    <p>Analyzing content...</p>
                </div>

                <div id="safeState" class="state safe-state" style="display: none;">
                    <div class="state-icon">âœ“</div>
                    <p>Content assessed as safe</p>
                </div>

                <div id="riskState" class="state risk-state" style="display: none;">
                    <div class="state-icon">!</div>
                    <p>Potential risk detected</p>
                </div>
            </div>
        </div>

        <!-- Analysis Results Panel -->
        <div class="results-panel">
            <div id="resultsEmpty" class="results-empty">
                <p>Analysis results will appear here</p>
            </div>

            <div id="resultsContent" class="results-content" style="display: none;">
                <!-- Risk Score -->
                <div class="risk-section">
                    <div class="risk-meter">
                        <div class="risk-bar" id="riskBar"></div>
                    </div>
                    <div class="risk-labels">
                        <span class="risk-value" id="riskScore">0</span>
                        <span class="risk-status" id="riskStatus">Safe</span>
                    </div>
                </div>

                <!-- Detection Labels -->
                <div class="detections-section">
                    <h3>Detections</h3>
                    <div id="labelsContainer" class="labels-minimal"></div>
                </div>

                <!-- Why This is Harmful -->
                <div class="analysis-summary">
                    <h3>Why This is Harmful</h3>
                    <p id="explanationText"></p>
                </div>

                <!-- Victim Support Guidance -->
                <div id="victimSupportSection" class="victim-support-section" style="display: none;">
                    <h3>Support for You</h3>
                    <p id="victimSupportText"></p>
                </div>

                <!-- Safe Response Steps -->
                <div id="safeResponsesSection" class="safe-responses-section" style="display: none;">
                    <h3>Safe Response Steps</h3>
                    <div id="safeResponsesList" class="responses-list"></div>
                </div>

                <!-- Parent Alert -->
                <div id="alertInfo" class="alert-notification" style="display: none;">
                    <span class="alert-icon">âš </span>
                    <span class="alert-text">Parent notified of high-risk content</span>
                </div>
            </div>

            <!-- Recent Agent Insights -->
            <div class="agent-insights">
                <h4>Recent Insights</h4>
                <div id="insightsPanel" class="insights-list">
                    {% if history %}
                        {% for item in history %}
                        <div class="history-item" onclick="showHistoryDetail('{{ item.explanation | replace('\\', '\\\\') | replace('\'', '\\\'') | replace('\"', '\\\"') | replace('\n', ' ') | replace('\r', ' ') }}')">
                            <div class="history-info">
                                <span class="history-preview">{{ item.content_preview }}</span>
                                <div class="history-meta">
                                    <span>{{ item.timestamp.strftime('%H:%M') }}</span>
                                    <span class="severity-badge severity-{{ item.severity_level.lower() }}">{{ item.severity_level }}</span>
                                </div>
                            </div>
                            <div class="history-score">{{ item.toxicity_score }}%</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No recent analysis</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Support Panel -->
    <div class="support-panel">
        <h3><span class="icon">ðŸ’™</span> Support & Guidance</h3>
        <div class="support-content">
            <p>Remember: You are not alone. CareCloud is here to help you navigate online spaces safely. If you encounter something that makes you feel uncomfortable, take a deep breathâ€”it's okay to ask for help.</p>
            
            <div class="support-steps">
                <div class="support-step">
                    <h4>For Students</h4>
                    <p>If you're upset, talk to a trusted adult. It's okay to step away from the screen for a while.</p>
                </div>
                <div class="support-step">
                    <h4>For Parents</h4>
                    <p>Use these insights as a starting point for a supportive, non-judgmental conversation about online safety.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reason Modal -->
<div id="reasonModal" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeReasonModal()">&times;</button>
        <div class="modal-header">
            <h2>Analysis Explanation</h2>
        </div>
        <div id="modalBody" class="modal-body">
            <p id="modalExplanation"></p>
            <div class="analysis-summary" style="margin-top: 1.5rem;">
                <h3>Why was this flagged?</h3>
                <p>Our AI detected patterns in the content that match common safety concerns. This explanation is meant to help you understand the context and stay safe.</p>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}
