{% extends "base.html" %}

{% block title %}Parent Dashboard{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Welcome, {{ user.name }} üõ°Ô∏è</h1>
    <p>Monitoring your linked children's accounts for emotional safety.</p>
</div>

<div class="dashboard-grid">
    <!-- Alerts Section -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Activity Alerts</h2>
            <button onclick="downloadReport()" class="btn-secondary" style="font-size: 0.9rem;">üì• Download Report</button>
        </div>
        <p class="section-desc">We'll notify you here if we detect anything that might need your attention.</p>

        <div class="search-filters" style="margin-bottom: 1.5rem; display: flex; gap: 1rem;">
            <input type="text" id="searchInput" placeholder="Search by child name or reason..." style="flex:1; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
            <select id="severityFilter" style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
                <option value="all">All Severities</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
            </select>
        </div>

        {% if alerts %}
            <div class="alerts-list" id="alertsList">
                {% for alert in alerts %}
                    <div class="alert-item severity-{{ alert.severity_level|lower }}" data-severity="{{ alert.severity_level }}">
                        <div class="alert-header">
                            <span class="alert-date">{{ alert.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                            <span class="alert-badge">{{ alert.severity_level }}</span>
                            <span class="alert-child">Child: <strong>{{ alert.child.name }}</strong></span>
                        </div>
                        <div class="alert-body">
                            <!-- Categories Badge -->
                            {% if alert.categories %}
                                <div class="category-tags" style="margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.8rem; font-weight: bold; color: #6b7280;">Detected:</span>
                                    <!-- Simple parse since we know it's a list string or we can just display -->
                                    <span style="background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">
                                        {{ alert.categories | replace('[', '') | replace(']', '') | replace('"', '') }}
                                    </span>
                                </div>
                            {% endif %}

                            <!-- Truncated Explanation -->
                            <h4>Reason for Alert:</h4>
                            <p class="alert-excerpt">{{ alert.explanation[:100] }}...</p>

                            <button onclick='openModal({{ alert.id }}, {{ alert.toxicity_score }}, "{{ alert.severity_level }}", {{ alert.categories if alert.categories else "[]" }}, {{ alert.explanation | tojson }})' class="btn-text" style="color: var(--primary-color); font-size: 0.9rem; margin-top: 0.5rem; border: none; background: none; cursor: pointer; padding: 0;">
                                View Details &rarr;
                            </button>
                        </div>
                        <div class="alert-footer">
                            <small>Toxicity Score: {{ alert.toxicity_score }}/100</small>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <p>‚úÖ All clear! No harmful content detected recently.</p>
            </div>
        {% endif %}
    </div>

    <!-- Guidance Section -->
    <div class="card">
        <h2>Parental Guidance üíô</h2>
        <p>Tips for having supportive conversations.</p>

        <div class="guidance-list">
            <div class="guidance-item">
                <h3>üó£Ô∏è How to Talk About It</h3>
                <p>Approach with curiosity, not anger. "I noticed you might be dealing with something tough online. Want to tell me about it?"</p>
            </div>

            <div class="guidance-item">
                <h3>üëÇ Listen First</h3>
                <p>Let them explain the context without interrupting. They might be the victim, or they might have made a mistake in the heat of the moment.</p>
            </div>

            <div class="guidance-item">
                <h3>ü§ù Focus on Impact</h3>
                <p>Help them understand how words affect feelings. "How do you think reading that would make someone feel?"</p>
            </div>

            <div class="guidance-item">
                <h3>üõë When to Step In</h3>
                <p>If you see signs of severe threats, self-harm, or persistent harassment, it may be time to block users or report content on the platform.</p>
            </div>
        </div>
    </div>

    <!-- Learn More Section -->
    <div class="card" style="margin-top: 2rem; grid-column: span 2;">
        <h2>Learn More üìö</h2>
        <div class="guidance-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="guidance-item" style="border: none;">
                <h3>üõ°Ô∏è Online Safety Basics</h3>
                <p>Understand privacy settings, blocking features, and how to report content on major social platforms.</p>
                <a href="#" style="color: var(--primary-color);">Read Guide &rarr;</a>
            </div>
            <div class="guidance-item" style="border: none;">
                <h3>üß† Mental Health Resources</h3>
                <p>Find professional support and helplines if your child is experiencing severe distress.</p>
                <a href="#" style="color: var(--primary-color);">Find Support &rarr;</a>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; width: 90%; position: relative;">
        <span onclick="closeModal()" style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer;">&times;</span>
        <h2 style="margin-bottom: 1rem;">Alert Details</h2>

        <div style="margin-bottom: 1.5rem;">
            <span id="modalBadge" class="alert-badge" style="margin-right: 0.5rem;">High</span>
            <span id="modalScore" style="color: var(--text-secondary); font-size: 0.9rem;">Score: 85/100</span>
        </div>

        <div style="margin-bottom: 1rem;">
            <h4 style="margin-bottom: 0.5rem;">Detected Categories:</h4>
            <div id="modalCategories" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 0.5rem;">Full Explanation:</h4>
            <p id="modalExplanation" style="line-height: 1.6; color: var(--text-secondary);"></p>
        </div>

        <div style="background: #eff6ff; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--primary-color);">
            <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">Parental Guidance:</h4>
            <p style="font-size: 0.9rem;">This content was flagged. Please have a calm, open conversation with your child. Ask them about context and how they felt.</p>
        </div>
    </div>
</div>

<script>
    // Modal Logic
    const modal = document.getElementById('detailsModal');

    function openModal(id, score, severity, categories, explanation) {
        document.getElementById('modalScore').textContent = `Score: ${score}/100`;
        document.getElementById('modalBadge').textContent = severity;
        document.getElementById('modalExplanation').textContent = explanation;

        const catsDiv = document.getElementById('modalCategories');
        catsDiv.innerHTML = categories.map(c => `<span class="category-badge">${c}</span>`).join('');

        modal.style.display = 'flex';
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    // Search & Filter Logic
    const searchInput = document.getElementById('searchInput');
    const severityFilter = document.getElementById('severityFilter');
    const alertsList = document.getElementById('alertsList');
    const alerts = document.querySelectorAll('.alert-item');

    function filterAlerts() {
        const searchTerm = searchInput.value.toLowerCase();
        const severity = severityFilter.value;

        alerts.forEach(alert => {
            const text = alert.innerText.toLowerCase();
            const alertSeverity = alert.dataset.severity;

            const matchesSearch = text.includes(searchTerm);
            const matchesSeverity = severity === 'all' || alertSeverity === severity;

            if (matchesSearch && matchesSeverity) {
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', filterAlerts);
    severityFilter.addEventListener('change', filterAlerts);

    // Download Report Mock Function
    function downloadReport() {
        const originalContent = document.body.innerHTML;
        const printContent = document.querySelector('.alerts-list').outerHTML;

        const w = window.open();
        w.document.write(`
            <html><head><title>CareCloud Report</title>
            <style>
                body { font-family: sans-serif; padding: 20px; }
                .alert-item { border-bottom: 1px solid #ccc; padding: 10px 0; margin-bottom: 10px; }
                .alert-header { font-weight: bold; margin-bottom: 5px; }
            </style>
            </head><body>
            <h1>CareCloud Activity Report</h1>
            <p>Generated on ${new Date().toLocaleString()}</p>
            <hr>
            ${printContent}
            </body></html>
        `);
        w.print();
        w.close();
    }
</script>
{% endblock %}
